# 第4章 Azure を実務で使うためのよくあるアーキテクチャを押さえる - 発展したアーキテクチャ

このドキュメントでは、本編で紹介しきれなかった各シナリオの発展したアーキテクチャを紹介します。
より可用性の高い構成、よりセキュアな構成、よりスケーラブルな構成など、実務で使用する際に考慮すべきポイントを解説します。

## シナリオ1: オンプレミスからの仮想マシンの移行とハイブリッド接続

本編で紹介した構成に加え、ネットワークの観点で、ExpressRoute を複数の場所(データセンター)に展開できます。ExpressRoute は、サービスプロバイダーのデータセンターに物理的な回線を展開し、ユーザーのネットワーク機器と接続するポイントです。そのため、ExpressRoute を展開する際には「東日本」や「西日本」のような Azure のリージョンではなく、サービスプロバイダーが提供するデータセンターの「場所」を指定します。

たとえば、東日本には Tokyo や Tokyo2 などの場所があります。仮に Tokyo で障害が発生した場合、当然ながら Tokyo で接続している ExpressRoute は利用できなくなりますが、Tokyo2 には影響がありません。複数の場所に ExpressRoute を展開することで、データセンターの障害に対する冗長化が実現できます。

[回復性に向けて Azure ExpressRoute を考案し設計する](https://learn.microsoft.com/ja-jp/azure/expressroute/design-architecture-for-resiliency)

ExpressRoute の冗長化手段として VPN を活用する方法もあります。VPN はインターネットを介するため閉域接続ではありませんが、非常用の経路として安価で迅速に展開できます。

[Azure portal を使用して ExpressRoute およびサイト間の共存接続を構成する](https://learn.microsoft.com/ja-jp/azure/expressroute/how-to-configure-coexisting-gateway-portal)

## シナリオ2: Web アプリケーションの展開

本編で紹介した構成に加え、アプリケーションの実行環境を他のリージョンに展開することで可用性を向上できます。\
シナリオ内で利用した Azure Front Door はグローバルな負荷分散を提供しており、異なるリージョンに展開した App Service に対してバックエンドとして設定できます。\
考慮事項として、2つ目のリージョンにも同等の構成を展開するため、コストは2倍になります。
また、データベースは1つ目のリージョンに存在するため、データベースのレプリケーション可否や切り替え時のデータ整合性を考慮する必要があります。

Azure Database for PostgreSQL Flexible Server では、geo 冗長バックアップと geo レプリケーション機能を提供しており、リージョン障害からの復旧に利用できます。\
[Azure Database for PostgreSQL - フレキシブル サーバーでのビジネス継続性の概要](https://learn.microsoft.com/ja-jp/azure/postgresql/flexible-server/concepts-business-continuity)

また、データへのアクセスをキャッシュするために Azure Cache for Redis の利用が検討できます。

[Azure Cache for Redis とは](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-overview)

用途によってリレーショナルデータベースと使い分けることで、アプリケーションのパフォーマンス向上が図れます。一方で、インメモリデータベースの特性上、データの永続化や冗長化がリレーショナルデータベースと比べて難しく、データ損失の可能性があります。\
また、キャッシュを導入することで、システム全体の複雑性の増加やコストの増加、SLA の低下が懸念されます。キャッシュの更新方法やキャッシュへアクセスできなかった場合の挙動を十分に検討した上で導入します。

## シナリオ3: 仮想デスクトップ基盤の展開 (Azure Virtual Desktop)

AVD では本編で紹介した機能のほかにも様々な機能と組み合わせたアーキテクチャが実現できます。

### マルチリージョン フェイルオーバー

AVD のセッション ホストを 2 つの地理的に分散したリージョンに配置することで、一方のリージョンで障害が発生した場合に別のリージョンで AVD の利用を継続できます。

### 高度なセキュリティ管理

Microsoft の提供するエンドポイント セキュリティ製品である Microsoft Defender for Endpoint は、AVD でも利用できます。
物理的な PC と同様のセキュリティ レベルを AVD でも保つことで、社内 IT 全体に対して統一した管理が可能です。

### 端末管理

Intune によるエンドポイント管理も AVD で利用可能です。
Active Directory を利用したドメイン参加の構成であればグループ ポリシーでの制御となりますが、Entra参加の構成であれば Intune ポリシーを使って端末の機能を制御できます。

### イメージ管理

AVD ではユーザーが利用する端末の「イメージ」の管理が必要ですが、Azure VM Image Builder と Azure Compute Gallery を利用することでこれらのタスクを省力化できます。
一般的なイメージ作成では sysprep を利用しますが、Azure VM Image Builder を利用すると、Azure Marketplace にある既存のイメージに対して、言語パックやアプリケーションのインストールなどをカスタマイズし、手動での作業を減らしたイメージ作成が可能です。
作成されたイメージは Azure Compute Gallery を利用し、東日本リージョンと西日本リージョンでの自動的なレプリカ作成により、高速なイメージ展開を可能にしています。


## シナリオ4: IoT デバイスのリアルタイムなデータモニタリング

現代のIoTソリューションは常に進化し、よりインテリジェントで統合されたエコシステムを構築するための新たな技術と戦略を取り入れています。次のポイントは、既存のアーキテクチャをさらに発展させるためのアイデアを提供します。

* エッジコンピューティングの強化: Azure IoT Edgeを利用してエッジ側でのデータ処理を拡大し、中央のクラウド処理に依存することなく、デバイスレベルで即時の意思決定を可能にします。これにより、レイテンシの大幅な削減と帯域幅の最適化が可能になります。
* データレイクとビッグデータ分析の統合: Azure Data Lake Storage Gen2、Azure Cosmos DB、そしてAzure Data Explorerを活用し、蓄積されたデータに対してMicrosoft Fabricを用いて横断的な分析を行います。この統合により、さまざまなデータソースからの情報を一元化し、より深い洞察を得ることができます。
* 自動化と連携の最適化: Azure Logic Appsを用いて、異なるサービスやプロセス間のワークフローを自動化し、複雑なタスクの実行を簡略化します。Azure Logic AppsはAPI経由で異なるAzureサービスを連携させ、事実上どんなカスタムプロセスも実現可能にします。
* 予測モデルのリアルタイム実行: 予測モデルをエッジデバイスに組み込むことで、運用データに基づいてリアルタイムで予測を行い、機器の故障を事前に警告するなど、プロアクティブなメンテナンスが可能になります。これにはAzure Machine LearningとAzure IoT Edgeの組み合わせが活用されます。
* インタラクティブなユーザーエクスペリエンス: Azure Digital Twinsと統合されたMR(Mixed Reality)テクノロジーを利用して、ユーザーが実際のデバイスやそのデジタルツインと対話できるようにします。これにより、メンテナンスや設計改善の過程でのユーザー体験が向上します。

これらの発展ポイントは、Azure IoTアーキテクチャの柔軟性を示し、将来のニーズに合わせてシステムを拡張するための基盤を提供します。また、これらの技術を適用することで、企業は新たなイノベーションの機会を探ることができ、競争優位性を保持することが可能です。

[Azure IoT 参照アーキテクチャ](https://learn.microsoft.com/ja-jp/azure/architecture/reference-architectures/iot)

## シナリオ5: 社内チャットによる文章の検索と回答生成(Azure OpenAI ServiceとAzure AI Searchによる RAG)

本編で紹介したシナリオをベースに、検索・回答生成対象となっているデータソースやメディアタイプの拡充、フィードバックの収集や分析を行うことで、システムの機能性や精度を向上できます。

* マルチモーダル対応の拡張: 今後、テキストだけでなく、画像やビデオも検索と回答生成の対象に含めることで、より豊富なメディアフォーマットをサポートします。GPT-4 Turbo with VisionなどのVisionモデルを使って実現可能です。
* フィードバックの収集とログの分析: 回答結果に対するユーザーフィードバックを収集し、AIモデルの継続的な学習と精度向上を図ります。また、Azure Cosmos DBに蓄積された会話履歴からユーザーの要求や回答結果を分析します。これにより、システム全体のパフォーマンスが向上し、ユーザーエクスペリエンスがさらに向上します。
* さまざまなデータソースとの統合: 企業内の文章だけでなく、データベースやCRM等との統合を強化し、AIが企業の業務プロセスに深く融合するようにします。これにより、業務効率の大幅な改善とデータ活用の最大化が実現します。

次のサンプルコードやリファレンスアーキテクチャも参考にしてください。

[Azure OpenAIとAzure AI Searchを使ったRAGアプリのサンプルコード「ChatGPT + Enterprise data with Azure OpenAI and AI Search」](https://github.com/Azure-Samples/azure-search-openai-demo/tree/main)

[ベースライン OpenAI エンドツーエンド チャット リファレンス アーキテクチャ](https://learn.microsoft.com/ja-jp/azure/architecture/ai-ml/architecture/baseline-openai-e2e-chat)
